
import random
import threading
import time
from concurrent import futures

import requests
from pyquery import PyQuery

headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) \
                  Chrome/53.0.2785.104 Safari/537.36 Core/1.53.2306.400 QQBrowser/9.5.10530.400'}
# 检测代理ip有效性的网站
#CHECK_URL = 'https://ip.cn'
CHECK_URL = 'https://www.baidu.com'
# 抓取地址(西刺代理)
FETCH_URL = 'http://www.xicidaili.com/wn/{}'
# 抓取页数，每页100条
PAGES = 5
# 代理类型（http/https）
PROXY_TYPE = 'https'
# 有效代理ip列表
proxies = []
# 线程池，用于同时验证多个代理ip
POOL = futures.ThreadPoolExecutor(max_workers=50)

IP = """173.249.35.163:10010
124.158.177.171:23500
201.151.79.30:8080
183.89.144.234:8080
1.10.189.156:39522
178.32.80.233:8080
117.121.207.172:8080
43.245.218.166:53281
103.197.92.174:8080
103.231.190.55:8080
47.254.159.125:3128
96.9.73.177:8080
213.33.224.82:8080
51.15.193.253:3128
83.169.208.183:61089
47.254.159.231:3128
186.4.137.105:8080
191.35.144.225:8080
91.92.80.25:53794
187.44.168.134:8080
145.239.169.43:8080
1.186.151.206:36253
47.254.148.247:3128
169.239.50.7:8080
202.44.45.25:8080
124.41.243.22:47894
103.9.188.160:46739
5.35.105.3:53281
186.219.210.222:54626
112.199.95.106:1
186.249.213.65:52018
138.122.143.150:31598
180.179.13.135:80
38.134.10.106:53281
119.82.252.25:32658
118.175.207.38:8080
176.101.177.189:8080
177.11.235.44:8080
94.54.35.246:3128
202.57.37.197:30007
94.240.221.20:8080
139.99.219.230:8080
35.245.208.185:3128
201.20.77.237:8080
93.170.15.177:41848
31.23.96.167:3128
125.26.7.85:54888
79.137.73.163:3128
138.201.223.250:31288
168.196.207.218:52821
185.7.169.143:8080
95.174.109.43:36804
27.147.216.140:80
186.226.179.2:56089
103.56.156.186:8888
47.254.158.1:3128
118.173.233.152:41245
186.103.175.158:3128
110.34.3.74:8080
41.222.2.202:8080
45.5.152.215:8080
47.254.156.113:3128
46.229.187.169:53281
31.220.183.217:53281
47.254.144.246:3128
45.238.252.77:3128
103.213.116.134:8080
154.236.177.108:8080
200.115.48.82:3128
200.122.211.18:8080
200.16.208.187:8080
41.254.41.94:8080
49.49.152.119:8080
182.52.51.20:36262
47.254.148.137:3128
27.147.179.232:8080
186.42.173.122:42589
183.88.76.42:8080
103.206.229.1:35144
200.255.122.170:8080
70.37.111.187:80
116.71.132.53:8080
180.183.230.195:8080
101.109.255.97:40209
106.249.44.10:3128
103.35.64.12:3128
181.129.98.146:8080
180.87.195.22:44997
190.196.15.43:3128
200.125.33.106:8080
34.67.66.107:8080
195.9.114.222:63141
179.155.183.121:8080
43.225.23.26:8080
176.120.221.115:8080
49.49.28.155:8080
171.100.43.122:8080
125.26.165.17:52567
46.188.109.21:45952
50.236.249.2:8080"""



def add_proxy(proxy: str):
    """
    添加代理
    :param proxy: 代理ip+端口号
    :return:
    """
    try:
        r = requests.get(CHECK_URL, proxies={PROXY_TYPE: proxy}, timeout=30)
        print(PyQuery(r.content.decode()).find('#result').text(), '\n')

        if r.status_code == 200 and proxy not in proxies:
            proxies.append(proxy)
    except Exception as e:
        if proxy in proxies:
            proxies.remove(proxy)
        print(proxy, e)

if __name__ == '__main__':
    ip = IP.split('\n')
    for i in ip:
        add_proxy(i)
        print('有效代理：', proxies[-1:])
        with open('ips1.txt', 'w', encoding='utf-8') as f:
            f.write('\n'.join(proxies))


